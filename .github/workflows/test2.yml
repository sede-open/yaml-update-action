name: 'test call to yaml-update-action'
on:
  push:
    branches:
      - spike/test-action

jobs:
#  build:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#      - run: |
#          npm install
#      - run: |
#          npm run all
#  test:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#      - uses: ./
#        with:
#          valueFile: 'sample_tests/tf_workspace.yaml'
#          propertyPath: 'spec.forProvider.*Args[*s3_object_version*]'
#          masterBranchName: main
#          value: v1.0.1-test
#          branch: feature/codeql_scanning
#          targetBranch: main
#          createPR: 'false'
#          commitChange: 'false'
#          message: 'Update s3_object_version'
#          token: ${{ secrets.GH_TOKEN }}

#  test-no-changes-did-not-fail:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#      - uses: ./
#        with:
#          valueFile: '__tests__/fixtures/values.yaml'
#          propertyPath: 'backend.version'
#          masterBranchName: main
#          value: v1.2.0
#          branch: deployment/v1.2.0
#          targetBranch: main
#          createPR: 'false'
#          message: 'Update Image Version to v1.2.0'
#          token: ${{ secrets.GH_TOKEN }}
#
#
#  test-target-repository:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#        with:
#          path: infrastructure
#      - name: Update values.yaml
#        uses: ./infrastructure
#        with:
#          valueFile: '__tests__/fixtures/values.yaml'
#          propertyPath: 'backend.version'
#          value: v1.2.1
#          masterBranchName: main
#          branch: deployment/v1.2.1
#          targetBranch: main
#          createPR: 'false'
#          message: 'Update Image Version to v1.2.1'
#          workDir: infrastructure
#          token: ${{ secrets.GH_TOKEN }}

  test-update-file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cat Original yaml file
        run: cat sample_tests/tf_workspace.yaml
      - name: Update yaml file
        uses: ./
        with:
          valueFile: 'sample_tests/tf_workspace.yaml'
          propertyPath: 'spec.forProvider.planArgs[2]'
          value: "-var s3_object_version=v1.0.1-test"
          masterBranchName: main
          commitChange: 'false'
          updateFile: 'true'
      - name: Cat Updated yaml file
        run: cat sample_tests/tf_workspace.yaml

  test-update-file-2:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cat Original yaml file
        run: |
          cat sample_tests/tf_workspace.yaml
          cat sample_tests/wbsds_app_kustomization.yaml
      - name: Update workspace yaml file
        uses: ./
        with:
          valueFile: 'sample_tests/tf_workspace.yaml'
          masterBranchName: main
          commitChange: 'false'
          updateFile: 'true'
          changes: |
            {
              "spec.forProvider.planArgs[2]": "-var semantic-version=v1.0.1-test",
              "spec.forProvider.applyArgs[2]": "-var semantic-version=v1.0.1-test",
              "spec.forProvider.destroyArgs[2]": "-var semantic-version=v1.0.1-test"
            }
      - name: Update kustomization yaml file
        uses: ./
        with:
          valueFile: 'sample_tests/wbsds_app_kustomization.yaml'
          masterBranchName: main
          commitChange: 'false'
          updateFile: 'true'
          changes: |
            {
              "images[0].newTag": "xyz123",
              "images[1].newTag": "abc456"
            }
      - name: Cat Updated yaml file
        run: |
          cat sample_tests/tf_workspace.yaml
          cat sample_tests/wbsds_app_kustomization.yaml
  
  test-multiple-file-changes-custom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cat Original yaml file
        run: |
          cat sample_tests/tf_workspace.yaml
          cat sample_tests/wbsds_app_kustomization.yaml
      - uses: ./
        with:
          masterBranchName: main
          commitChange: 'false'
          updateFile: 'true'
          changes: |
            {
              "sample_tests/tf_workspace.yaml": {
                "spec.forProvider.planArgs[2]": "-var semantic-version=v1.0.1-test",
                "spec.forProvider.applyArgs[2]": "-var semantic-version=v1.0.1-test",
                "spec.forProvider.destroyArgs[2]": "-var semantic-version=v1.0.1-test"
              },
              "sample_tests/wbsds_app_kustomization.yaml": {
                "images[0].newTag": "xyz123",
                "images[1].newTag": "abc456"
              }
            }
      - name: Cat Updated yaml file
        run: |
          cat sample_tests/tf_workspace.yaml
          cat sample_tests/wbsds_app_kustomization.yaml

  test-update-file-wildcard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cat Original yaml file
        run: cat sample_tests/tf_workspace.yaml
      - name: Update yaml file
        uses: ./
        with:
          valueFile: 'sample_tests/tf_workspace.yaml'
          propertyPath: 'spec.forProvider.*Args[2]'
          value: "-var s3_object_version=v1.0.1-test"
          masterBranchName: main
          commitChange: 'false'
          updateFile: 'true'
      - name: Cat Updated yaml file
        run: cat sample_tests/tf_workspace.yaml

  tf-workspace2-test-multiple-file-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cat Original yaml file
        run: |
          cat sample_tests/tf_workspace_2.yaml
          cat sample_tests/wbsds_app_kustomization.yaml
      - uses: ./
        with:
          masterBranchName: main
          commitChange: 'false'
          updateFile: 'true'
          changes: |
            {
              "sample_tests/tf_workspace_2.yaml": {
                "spec.forProvider.vars[?(@.key == 'semantic_version')].value": "v1.0.1-test"
              },
              "sample_tests/wbsds_app_kustomization.yaml": {
                "images[0].newTag": "xyz123",
                "images[1].newTag": "abc456"
              }
            }
      - name: Cat Updated yaml file
        run: |
          cat sample_tests/tf_workspace_2.yaml
          cat sample_tests/wbsds_app_kustomization.yaml
#  test-value-types:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#      - uses: ./
#        with:
#          valueFile: '__tests__/fixtures/values.yaml'
#          propertyPath: 'config.prod'
#          value: "!!bool 'true'"
#          branch: deployment/test-bool-value
#          masterBranchName: main
#          targetBranch: main
#          description: Test GitHub Action
#          message: 'Update Config'
#          title: 'Bool Update on all Environments'
#          token: ${{ secrets.GH_TOKEN }}
#      - uses: ./
#        with:
#          valueFile: '__tests__/fixtures/values.yaml'
#          propertyPath: 'config.version'
#          value: "!!int '1234'"
#          branch: deployment/test-int-value
#          masterBranchName: main
#          targetBranch: main
#          description: Test GitHub Action
#          message: 'Update Config'
#          title: 'Int Update on all Environments'
#          token: ${{ secrets.GH_TOKEN }}

#  cleanup:
#    runs-on: ubuntu-latest
#    needs:
#      - test-target-repository
#      - test-update-file
#      - test-multiple-file-changes
#      - test-value-types
#    steps:
#      - uses: actions/checkout@v3
#      - name: Delete test branches
#        uses: dawidd6/action-delete-branch@v3
#        with:
#          token: ${{ secrets.GH_TOKEN }}
#          branches: deployment/v1.2.1,deployment/v1.0.1,deployment/test-bool-value,deployment/test-int-value,deployment/test-multi-file-update
